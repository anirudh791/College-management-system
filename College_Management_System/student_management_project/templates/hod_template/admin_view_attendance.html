{% extends 'hod_template/base_template.html' %}
{% block page_title %}
    View Attendance
{% endblock page_title %}
{% block main_content %}
<section class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12">
                <div class="card card-primary">
                    <div class="card-header">
                        <h3 class="card-title">View Attendance</h3>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label>Subject</label>
                            <select class="form-control" name="subject" id="subject" required>
                                <option value="">--- Select Subject ---</option>
                                {% for subject in subjects %}
                                    <option value="{{ subject.id }}">{{ subject.subject_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Session Year</label>
                            <select class="form-control" name="session_year_id" id="session_year_id" required>
                                 <option value="">--- Select Session ---</option>
                                {% for session in session_years %}
                                    <option value="{{ session.id }}">{{ session.session_start_year }} to {{ session.session_end_year }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Attendance Date</label>
                            <select class="form-control" name="attendance_date" id="attendance_date" required>
                                <option>--- Select Date ---</option>
                            </select>
                        </div>
                        <div class="form-group">
                           <button type="button" class="btn btn-primary" id="fetch_student_button">Fetch Students</button>
                        </div>
                    </div>
                </div>

                <div class="card" id="student_attendance_div" style="display:none;">
                    <div class="card-header">
                        <h3 class="card-title">Student Attendance</h3>
                    </div>
                    <div class="card-body table-responsive p-0">
                         <table class="table table-hover text-nowrap" id="student_attendance_table">
                             <thead>
                                 <tr>
                                     <th>Student ID</th>
                                     <th>Student Name</th>
                                     <th>Status</th>
                                 </tr>
                             </thead>
                             <tbody></tbody>
                         </table>
                    </div>
                </div>

            </div>
        </div>
    </div>
</section>
{% endblock main_content %}
{% block custom_js %}
<script>
$(document).ready(function(){
    // Fetch attendance dates when subject and session are selected
    $("#session_year_id").change(function(){
        var subject_id = $("#subject").val();
        var session_year_id = $(this).val();

        if(subject_id !== "" && session_year_id !== ""){
            $.ajax({
                url: "{% url 'admin_get_attendance_dates' %}",
                type: 'POST',
                data: { subject: subject_id, session_year_id: session_year_id },
                success: function(response){
                    var data = JSON.parse(response);
                    var attendance_date_select = $("#attendance_date");
                    attendance_date_select.html('<option value="">--- Select Date ---</option>');
                    $.each(data, function(key, value){
                        attendance_date_select.append('<option value="'+ value.id +'">'+ value.attendance_date +'</option>');
                    });
                }
            });
        }
    });

    // Fetch students for a specific attendance date
    $("#fetch_student_button").click(function(){
        var attendance_date = $("#attendance_date").val();
        if(attendance_date === ""){
            alert("Please select an attendance date.");
            return;
        }

        $.ajax({
            url: "{% url 'admin_get_attendance_student' %}",
            type: 'POST',
            data: { attendance_date: attendance_date },
            success: function(response){
                var data = JSON.parse(response);
                var table_body = $("#student_attendance_table tbody");
                table_body.html("");
                $.each(data, function(key, value){
                    var status = value.status ? '<span class="badge badge-success">Present</span>' : '<span class="badge badge-danger">Absent</span>';
                    var row = '<tr><td>' + value.id + '</td><td>' + value.name + '</td><td>' + status + '</td></tr>';
                    table_body.append(row);
                });
                $("#student_attendance_div").show();
            }
        });
    });
});
</script>
{% endblock custom_js %}